{% extends 'reporting_base.html' %}
{% from 'datatable.html' import datatable, dt_header %}

{% block title %}{{ title }}{% endblock %}
{% block head %}
    {{ super() }}
    {{ dt_header() }}
{% endblock %}

{% block content %}

<h1>{{ title }}</h1>
{{ description }}

{% if tables %}
    {% for table in tables %}
    {{ datatable(table) }}
    {% endfor %}
{% elif table %}
    {{ datatable(table) }}
{% endif %}


<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>



<head>

<script type="text/javascript">



var hashtable = {};
var moment1 = moment('2016-03-21T00:00:00.000Z').week()
var moment2 = moment("2016-03-07T00:00:00.000Z").week()
hashtable[moment1] = 12
//console.log(hashtable)
hashtable[moment1] = hashtable[moment1] + 4








google.charts.load('current', {packages: ['corechart', 'line', 'bar']});
google.charts.setOnLoadCallback(drawMyChart);

function drawMyChart() {



      var data = {{ yield2date }};












      var all_month_year = []
      var all_week_year = []
      test_array = []

      var test_map = data.map(function(t){

             var week_year = []
             var month_year = []

             var date = moment(new Date(t[0]))
             week = date.format('W')
             month = date.format('M')
             year = date.format('Y')
             var v = [week, year]
             test_array.push(date)
      });












      min_date = moment.min(test_array)
      max_date = moment.max(test_array)
      min_week = min_date.format('W')
      min_month = min_date.format('M')
      min_year = min_date.format('Y')
      var number_of_weeks = max_date.diff(min_date, 'weeks') + 1
      var number_of_months = max_date.diff(min_date, 'months') + 1
      var week_range = Array.apply(null, {length: number_of_weeks}).map(Number.call, Number)
      var month_range = Array.apply(null, {length: number_of_months}).map(Number.call, Number)
      var weeks = {}
      var months = {}

      current_week = min_week
      current_year = min_year

      var populate_blank_weeks = week_range.map(function(t){
            if (current_week < 52) {
                  weeks[([parseInt(current_week), parseInt(current_year)])] = 0
                  current_week = parseInt(current_week, 10) + 1

            } else if (current_week == 52) {
                  weeks[([parseInt(current_week), parseInt(current_year)])] = 0
                  current_week = 1
                  current_year = parseInt(current_year, 10) + 1
            }
      });


      current_month = min_month
      current_year = min_year


      var populate_blank_months = month_range.map(function(t){
            if (current_month < 12) {
                  months[([parseInt(current_month), parseInt(current_year)])] = 0
                  current_month = parseInt(current_month, 10) + 1

            } else if (current_month == 12) {
                  months[([parseInt(current_month), parseInt(current_year)])] = 0
                  current_month = 1
                  current_year = parseInt(current_year, 10) + 1
            }
      });


      var aggregate_weeks = {}
      var aggregate_months = {}

      var available_dates = data.map(function(t){

            week_number = moment(new Date(t[0])).week()
            month_number = (moment(new Date(t[0])).month()) + 1
            year_number = moment(new Date(t[0])).year()

            var month_year = [month_number, year_number]
            var week_year = [week_number, year_number]

            if(typeof aggregate_weeks[week_year] == 'undefined'){
                aggregate_weeks[week_year] = t[1]
            } else {
                aggregate_weeks[week_year] = aggregate_weeks[week_year] + t[1]
            }

            if(typeof aggregate_months[month_year] == 'undefined'){
                aggregate_months[month_year] = t[1]
            } else {
                aggregate_months[month_year] = aggregate_months[month_year] + t[1]
            }
      });


      by_month_yield_data = []
      by_week_yield_data = []


      for (var key in weeks) {
            if(typeof aggregate_weeks[key] != 'undefined') {
                  by_week_yield_data.push([key, aggregate_weeks[key]])
            } else if(typeof aggregate_weeks[key] == 'undefined') {
                  by_week_yield_data.push([key, weeks[key]])
            }

      }


      for (var key in months) {
            if(typeof aggregate_months[key] != 'undefined') {
                  by_month_yield_data.push([key, aggregate_months[key]])
            } else if(typeof aggregate_months[key] == 'undefined') {
                  by_month_yield_data.push([key, months[key]])
            }

      }


      var run_yield_data = new google.visualization.DataTable();
      run_yield_data.addColumn('string', 'X');
      run_yield_data.addColumn('number', 'Yield');
      run_yield_data.addRows(by_month_yield_data);
      var run_yield_options = {
        hAxis: {title: 'Date'},
        vAxis: {title: 'Yield'}};
      var chart1 = new google.visualization.LineChart(document.getElementById('run_yield_by_date'));
      chart1.draw(run_yield_data, run_yield_options);

      var histogram_data = google.visualization.arrayToDataTable( {{ hist | safe }});
      var histogram_options = {
      title: 'Yield metrics',
      legend: { position: 'top', maxLines: 2 },
      colors: ['#5C3292', '#1A8763', '#871B47', '#999999'],
      interpolateNulls: false};
      var chart2 = new google.visualization.Histogram(document.getElementById('yield_histogram'));
      chart2.draw(histogram_data, histogram_options);
}

</script>
</head>

<body>
<div id="yield_histogram"></div>
<div id="run_yield_by_date"></div>

</body>



{% endblock %}